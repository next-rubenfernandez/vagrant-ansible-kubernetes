---
# tasks file for kubernetes

- name: Kubernetes | Add Kubernetes yum repository (RHEL/CentOS)
  yum_repository:
    name: Kubernetes
    description: Kubernetes Repository
    file: kubernetes
    baseurl: http://yum.kubernetes.io/repos/kubernetes-el7-x86_64
    enabled: yes
    gpgcheck: yes
    gpgkey: 
      - https://packages.cloud.google.com/yum/doc/yum-key.gpg 
      - https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

- name: Kubernetes | Put SELinux in permissive mode, logging actions that would be blocked.
  selinux: 
    policy: targeted 
    state: permissive

- name: Kubernetes | Install kubernetes packages (RHEL/CentOS)
  yum:
    name: "{{ kubernetes_packages }}"
    update_cache: yes
    state: installed
    disable_excludes: kubernetes

- name: Kubernetes | Disable SWAP since kubernetes can't work with swap enabled (1/2)
  shell: swapoff -a

- name: Kubernetes | Disable SWAP in fstab since kubernetes can't work with swap enabled (2/2)
  replace:
    path: /etc/fstab
    regexp: '^(.+?\sswap\s+sw\s+.*)$'
    replace: '# \1'

- name: Kubernetes | Disable swappiness and pass bridged IPv4 traffic to iptable's chains
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  with_items:
    - { name: 'vm.swappiness', value: '0' }
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }

- name: Kubernetes | Config completation bash kubectl
  command: kubectl completion bash

# - name: Create service drop-in directory
#   file:
#     path: /etc/systemd/system/kubelet.service.d/
#     state: directory
#     owner: ""
#     group: ""
#     mode: 0755

# - name: Copy kubeadm conf to drop-in directory
#   template: src=20-extra-args.conf.j2 dest=/etc/systemd/system/kubelet.service.d/20-extra-args.conf

# - name: Reload kubelet daemon
#   systemd:
#     name: kubelet
#     daemon_reload: yes
#     enabled: yes